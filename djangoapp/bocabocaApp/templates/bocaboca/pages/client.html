{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ bocaboca_setup.title }}</title>
  {% if bocaboca_setup.favicon %}
    <link rel="shortcut icon" href="{{ bocaboca_setup.favicon.url }}" type="image/png" />
  {% endif %}

  <!-- Bootstrap local (deve vir ANTES do seu CSS) -->
  <link rel="stylesheet" href="{% static 'vendor/bootstrap/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/bocaboca.css' %}?v=uniform1">
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body class="auth-page">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <img src="{% static 'brand/logo.png' %}" alt="logo" height="28" class="rounded-circle">
      <span class="fw-semibold">BocaBoca</span>
    </a>
    <div class="ms-auto d-flex align-items-center gap-3">
      <span class="text-white-50">Já tem uma conta?</span>
      <a href="{% url 'bocaboca:login' %}" class="btn btn-ghost">Login</a>
    </div>
  </div>
</nav>

<!-- HERO / CARD -->
<header class="auth-hero">
  <div class="container d-flex justify-content-center">
    <div class="card-lite auth-card text-start">
      <h2 class="auth-title">Crie sua conta</h2>
      <div class="auth-sub">Escolha e‑mail ou telefone para começar.</div>

      <!-- Abas -->
      <div class="tab-toggle" role="group" aria-label="Alternar método de cadastro">
        <button type="button" class="btn btn-toggle active" id="emailTab">E-mail</button>
        <button type="button" class="btn btn-toggle" id="phoneTab">Telefone</button>
      </div>

      <!-- ====== FORM: E-mail ====== -->
      <form method="POST" action="{% url 'bocaboca_profile:send_activation_link' %}" id="emailForm" novalidate>
        {% csrf_token %}
        <div class="mb-2">
          <label for="full-name" class="form-label">Nome completo</label>
          <input type="text" id="full-name" name="full_name" class="form-control" placeholder="Seu nome completo" required>
        </div>
        <div class="mb-2">
          <label for="email" class="form-label">E-mail</label>
          <input type="email" id="email" name="email" class="form-control" placeholder="voce@email.com" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Senha</label>
          <input type="password" id="password" name="password" class="form-control" placeholder="••••••••" minlength="6" required>
        </div>
        <input type="hidden" name="role" value="{{ request.session.role }}">
        <div class="g-recaptcha mb-3" data-sitekey="your-site-key"></div>
        <button class="btn btn-brand w-100" type="submit">Cadastrar com E-mail</button>
      </form>

      <!-- ====== FORM: Telefone (enviar código) ====== -->
      <form method="POST" action="{% url 'bocaboca_profile:send_sms_code' %}" id="sendCodeForm" class="d-none mt-2" novalidate>
        {% csrf_token %}
        <div class="mb-3">
          <label for="phone" class="form-label">Telefone</label>
          <input type="text" id="phone" name="phone" class="form-control" placeholder="(99) 99999-9999" required>
        </div>

        <!-- Feedback -->
        <div id="smsAlert" class="alert d-none" role="alert"></div>

        <div class="d-grid">
          <button type="submit" id="sendCodeBtn" class="btn btn-brand w-100">
            Enviar Código
          </button>
          <small id="countdownHint" class="text-muted-ink mt-2 d-none">
            Reenvio habilitado em <span id="countdown">60</span>s
          </small>
        </div>
      </form>

      <!-- ====== FORM: Telefone (validar código) ====== -->
      <form method="POST" action="{% url 'bocaboca_profile:validate_sms_code' %}" id="codeForm" class="d-none mt-3" novalidate>
        {% csrf_token %}
        <div class="mb-3">
          <label for="sms_code" class="form-label">Código de Verificação</label>
          <input type="text" id="sms_code" name="sms_code" class="form-control" placeholder="123456" inputmode="numeric" minlength="4" maxlength="6" required>
        </div>
        <div class="d-grid">
          <button type="submit" id="validateBtn" class="btn btn-brand w-100">
            Validar Código
          </button>
        </div>
      </form>
    </div>
  </div>
</header>

<!-- Bootstrap local -->
<script src="{% static 'vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>

<script>
  // ===== Helpers =====
  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (let i = 0; i < cookies.length; i++) {
      const parts = cookies[i].split('=');
      const key = decodeURIComponent(parts.shift());
      const value = parts.join('=');
      if (key === name) return decodeURIComponent(value);
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  function showAlert(el, type, msg) {
    el.className = 'alert alert-' + type;
    el.textContent = msg;
    el.classList.remove('d-none');
  }
  function hideAlert(el) { el.classList.add('d-none'); }

  // ===== Refs =====
  const emailTab = document.getElementById('emailTab');
  const phoneTab = document.getElementById('phoneTab');
  const emailForm = document.getElementById('emailForm');
  const sendCodeForm = document.getElementById('sendCodeForm');
  const codeForm = document.getElementById('codeForm');

  const smsAlert = document.getElementById('smsAlert');
  const sendCodeBtn = document.getElementById('sendCodeBtn');
  const phoneInput = document.getElementById('phone');
  const countdownEl = document.getElementById('countdown');
  const countdownHint = document.getElementById('countdownHint');
  const smsCodeInput = document.getElementById('sms_code');

  let countdownTimer = null;
  const RESEND_SECONDS = 60;

  // ===== Estado inicial
  emailTab.classList.add('active');
  emailForm.classList.remove('d-none');
  phoneTab.classList.remove('active');
  sendCodeForm.classList.add('d-none');
  codeForm.classList.add('d-none');

  // ===== Tabs =====
  emailTab.addEventListener('click', () => {
    emailTab.classList.add('active');
    phoneTab.classList.remove('active');
    emailForm.classList.remove('d-none');
    sendCodeForm.classList.add('d-none');
    codeForm.classList.add('d-none');
    hideAlert(smsAlert);
  });

  phoneTab.addEventListener('click', () => {
    phoneTab.classList.add('active');
    emailTab.classList.remove('active');
    emailForm.classList.add('d-none');
    sendCodeForm.classList.remove('d-none');
    codeForm.classList.add('d-none');
    hideAlert(smsAlert);
  });

  function startCountdown() {
    let remaining = RESEND_SECONDS;
    countdownEl.textContent = remaining;
    countdownHint.classList.remove('d-none');
    sendCodeBtn.disabled = true;
    sendCodeBtn.textContent = 'Código enviado';

    countdownTimer = setInterval(() => {
      remaining -= 1;
      countdownEl.textContent = remaining;
      if (remaining <= 0) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        countdownHint.classList.add('d-none');
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Reenviar Código';
      }
    }, 1000);
  }

  // ===== Enviar Código (AJAX) =====
  sendCodeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAlert(smsAlert);

    const phone = phoneInput.value.trim();
    if (!phone) {
      showAlert(smsAlert, 'warning', 'Informe um telefone válido.');
      return;
    }

    try {
      sendCodeBtn.disabled = true;

      const resp = await fetch(sendCodeForm.action, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': csrftoken },
        body: new FormData(sendCodeForm)
      });

      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        showAlert(smsAlert, 'danger', data.message || 'Falha ao enviar código. Tente novamente.');
        sendCodeBtn.disabled = false;
        return;
      }

      showAlert(smsAlert, 'success', data.message || 'Código enviado!');
      codeForm.classList.remove('d-none');
      startCountdown();

    } catch (err) {
      console.error(err);
      showAlert(smsAlert, 'danger', 'Erro inesperado ao enviar o código.');
      sendCodeBtn.disabled = false;
    }
  });

  // ===== Validar Código (AJAX) =====
  codeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAlert(smsAlert);

    const code = smsCodeInput.value.trim();
    if (!code) {
      showAlert(smsAlert, 'warning', 'Digite o código recebido por SMS.');
      return;
    }

    try {
      const resp = await fetch(codeForm.action, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sms_code: code })
      });

      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        showAlert(smsAlert, 'danger', data.message || 'Código inválido. Tente novamente.');
        return;
      }

      // Sucesso: redireciona para finalização de cadastro
      window.location.href = data.next_url;

    } catch (err) {
      console.error(err);
      showAlert(smsAlert, 'danger', 'Erro inesperado ao validar o código.');
    }
  });
</script>
</body>
</html>
